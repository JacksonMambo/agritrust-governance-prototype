<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AgriTrust Portal – Governance Prototype</title>
  <link rel="stylesheet" href="assets/styles.css?v=7.2"/>
</head>

<body>
<div class="wrap">

  <!-- Header -->
  <div class="top">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>AgriTrust Portal <span class="muted">v7</span></h1>
        <div class="sub">
          Role-based governance simulation: delivery capture, dispute handling, invoice sequencing, regulator traceability, and tamper-evident verification.
        </div>
      </div>
    </div>

    <div class="row">
      <a class="pill" href="index.html"><b>Home</b></a>
      <span class="pill"><b>Role</b>: <span id="roleName">—</span></span>
      <span class="pill"><b>User</b>: <span id="userName">—</span></span>
    </div>
  </div>

  <div class="portal-grid">

    <!-- Left Nav -->
    <nav>
      <div class="navhd">
        <div class="k">Navigation</div>
        <div class="t">Portal pages</div>
      </div>
      <div class="navlist" id="nav">
        <div class="navitem" data-pane="dashboard"><span class="dot"></span>Dashboard</div>
        <div class="navitem" data-pane="newdelivery"><span class="dot"></span>New delivery</div>
        <div class="navitem" data-pane="detail"><span class="dot"></span>Delivery detail</div>
        <div class="navitem" data-pane="regulator"><span class="dot"></span>Regulator trace</div>
        <div class="navitem" data-pane="verify"><span class="dot"></span>Ledger verify</div>
        <div class="navitem" data-pane="governance"><span class="dot"></span>Governance</div>
      </div>
    </nav>

    <!-- Main -->
    <main>

      <!-- Dashboard -->
      <section class="pane" id="pane-dashboard">
        <h2 style="margin:0 0 8px">Dashboard</h2>
        <p class="muted" style="margin-top:0">
          Summary KPIs and deliveries table. Content is filtered by role.
        </p>

        <div class="row" id="kpiRow"></div>

        <div class="card" style="margin-top:12px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3 style="margin:0">Deliveries</h3>
            <div class="row">
              <button class="btn ghost" id="btnReset">Reset demo data</button>
              <button class="btn" id="btnGotoNew">Create delivery</button>
            </div>
          </div>

          <div class="hr"></div>

          <table>
            <thead>
              <tr>
                <th>Delivery</th><th>Product</th><th>Qty</th><th>Delivery date</th><th>Due date</th><th>Status</th><th>Flags</th><th>Action</th>
              </tr>
            </thead>
            <tbody id="deliveriesTbody"></tbody>
          </table>

          <div class="small muted" style="margin-top:10px">
            Status flow: DELIVERED → CONFIRMED → DISPUTED/REJECTED → INVOICE_SUBMITTED → INVOICE_APPROVED → PAYMENT_SCHEDULED → PAID.
          </div>
        </div>
      </section>

      <!-- New Delivery -->
      <section class="pane" id="pane-newdelivery">
        <h2 style="margin:0 0 8px">New delivery</h2>
        <p class="muted" style="margin-top:0">
          Farmer/Admin only. Creates delivery record and writes a ledger event.
        </p>

        <div class="split">

          <div class="card">
            <h3 style="margin-top:0">Delivery form</h3>

            <div class="row">
              <div style="flex:1">
                <label>Buyer</label>
                <select id="f_buyer">
                  <option value="U-BUY-01">U-BUY-01 — Retail DC</option>
                  <option value="U-BUY-02">U-BUY-02 — Wholesaler</option>
                  <option value="U-BUY-03">U-BUY-03 — Feeding Scheme</option>
                </select>
              </div>
              <div style="width:170px">
                <label>Terms (days)</label>
                <input id="f_terms" type="number" value="30"/>
              </div>
            </div>

            <div class="row">
              <div style="flex:1">
                <label>Product</label>
                <input id="f_product" value="Spinach"/>
              </div>
              <div style="width:170px">
                <label>Quantity</label>
                <input id="f_qty" type="number" value="200"/>
              </div>
              <div style="width:150px">
                <label>UoM</label>
                <input id="f_uom" value="bundles"/>
              </div>
            </div>

            <div class="row">
              <div style="flex:1">
                <label>Delivery date</label>
                <input id="f_date" type="date"/>
              </div>
              <div style="flex:1">
                <label>Time zone</label>
                <input id="f_tz" value="Africa/Johannesburg"/>
              </div>
            </div>

            <div class="hr"></div>
            <h3 style="margin:0 0 8px;font-size:14px">GS1 / EPCIS-like fields (optional)</h3>

            <div class="row">
              <div style="flex:1"><label>GTIN (14)</label><input id="f_gtin" placeholder="00012345678905"/></div>
              <div style="flex:1"><label>Lot / Batch</label><input id="f_lot" placeholder="LOT-2026-02-11-A"/></div>
              <div style="flex:1"><label>SSCC (18)</label><input id="f_sscc" placeholder="000123456789012345"/></div>
            </div>

            <div class="row">
              <div style="flex:1"><label>GLN Farmer (13)</label><input id="f_gln_farmer" placeholder="1234567890123"/></div>
              <div style="flex:1"><label>GLN Buyer (13)</label><input id="f_gln_buyer" placeholder="9876543210987"/></div>
            </div>

            <div class="row" style="margin-top:12px">
              <button class="btn" id="btnCreateDelivery">Create delivery</button>
              <button class="btn ghost" id="btnCancelNew">Cancel</button>
            </div>

            <div class="small muted" style="margin-top:10px">
              Governance note: this creates a time-stamped delivery event and anchors trace identifiers for recall drills.
            </div>
          </div>

          <div class="card">
            <h3 style="margin-top:0">Preview payload</h3>
            <div class="muted small">What will be recorded in the ledger event.</div>
            <div class="hr"></div>
            <pre class="mono small" id="previewJson" style="white-space:pre-wrap;margin:0"></pre>
            <div class="row" style="margin-top:10px">
              <button class="btn ghost" id="btnPreview">Refresh preview</button>
            </div>
          </div>

        </div>
      </section>

      <!-- Delivery Detail -->
      <section class="pane" id="pane-detail">
        <h2 style="margin:0 0 8px">Delivery detail</h2>
        <p class="muted" style="margin-top:0">
          Buyer/Admin can confirm, dispute, upload evidence hash, and run invoice/payment pipeline.
        </p>

        <div class="row" style="margin:10px 0 12px">
          <button class="btn" id="btnAuditPack">Download Audit Pack (HTML)</button>
          <button class="btn ghost" id="btnRecallDrill">Open Recall Drill (Simulation)</button>
        </div>

        <div class="split">

          <div class="card">
            <h3 style="margin-top:0">Record</h3>
            <div class="muted small">Delivery: <span class="mono" id="d_ref">—</span></div>
            <div class="muted small">Status: <span id="d_status" class="badge warn">—</span></div>
            <div class="hr"></div>
            <div class="mono small" id="d_summary">—</div>
            <div class="hr"></div>
            <h3 style="margin:0 0 8px;font-size:14px">Dispute</h3>
            <div class="mono small" id="d_dispute">—</div>

            <div class="hr"></div>
            <h3 style="margin:0 0 8px;font-size:14px">Evidence SHA-256</h3>
            <div class="mono small" id="d_evidence">—</div>

            <div class="hr"></div>
            <h3 style="margin:0 0 8px;font-size:14px">Invoice & payment pipeline</h3>
            <div class="mono small" id="d_invoice">—</div>
          </div>

          <div class="card">
            <h3 style="margin-top:0">Actions</h3>
            <div class="small muted">Actions are enforced by role rules in this prototype.</div>

            <div class="row" style="margin-top:10px">
              <button class="btn secondary" id="btnConfirm">Confirm</button>
              <button class="btn ghost" id="btnDispute">Open dispute</button>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn ghost" id="btnUpload">Upload evidence (simulate)</button>
              <button class="btn ghost" id="btnResolve">Resolve dispute</button>
            </div>

            <div class="hr"></div>

            <div class="row">
              <button class="btn" id="btnSubmitInvoice">Submit invoice</button>
              <button class="btn ghost" id="btnApproveInvoice">Approve</button>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn ghost" id="btnSchedule">Schedule payment</button>
              <button class="btn secondary" id="btnPaid">Mark paid</button>
            </div>

            <div class="hr"></div>
            <button class="btn ghost" id="btnBackDash">Back to dashboard</button>

            <div class="hr"></div>
            <h3 style="margin:0 0 8px;font-size:14px">Ledger events</h3>
            <table>
              <thead><tr><th>ts</th><th>type</th><th>prev</th><th>hash</th></tr></thead>
              <tbody id="eventsTbody"></tbody>
            </table>
          </div>

        </div>
      </section>

      <!-- Regulator Trace -->
      <section class="pane" id="pane-regulator">
        <h2 style="margin:0 0 8px">Regulator trace</h2>
        <p class="muted" style="margin-top:0">
          Read-only filtering by GTIN/Lot/GLN and QR payload verification.
        </p>

        <div class="split">
          <div class="card">
            <h3 style="margin-top:0">Filters</h3>

            <div class="row">
              <div style="flex:1"><label>GTIN</label><input id="r_gtin" placeholder="14 digits"/></div>
              <div style="flex:1"><label>Lot</label><input id="r_lot" placeholder="LOT-..."/></div>
            </div>

            <div class="row">
              <div style="flex:1"><label>GLN Farmer</label><input id="r_gln_farmer" placeholder="13 digits"/></div>
              <div style="flex:1"><label>GLN Buyer</label><input id="r_gln_buyer" placeholder="13 digits"/></div>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn" id="btnSearch">Search</button>
              <button class="btn ghost" id="btnResetFilters">Reset</button>
              <button class="btn ghost" id="btnExportCsv">Export CSV</button>
            </div>

            <div class="hr"></div>
            <h3 style="margin:0 0 8px;font-size:14px">QR verify (paste JSON)</h3>
            <textarea id="r_qr" placeholder='{"delivery_ref":"D00007","latest_hash":"..."}'></textarea>

            <div class="row" style="margin-top:10px">
              <button class="btn secondary" id="btnVerifyQR">Verify QR vs ledger</button>
              <button class="btn ghost" id="btnUseCurrentQR">Use current delivery QR</button>
            </div>
          </div>

          <div class="card">
            <h3 style="margin-top:0">Results</h3>
            <table>
              <thead><tr><th>Delivery</th><th>GTIN</th><th>Lot</th><th>Farmer GLN</th><th>Buyer GLN</th><th>Status</th><th>Action</th></tr></thead>
              <tbody id="regResults"></tbody>
            </table>

            <div class="hr"></div>
            <pre class="mono small" id="qrResult" style="white-space:pre-wrap;margin:0">No QR verification run yet.</pre>
          </div>
        </div>
      </section>

      <!-- Ledger Verify -->
      <section class="pane" id="pane-verify">
        <h2 style="margin:0 0 8px">Ledger verify</h2>
        <p class="muted" style="margin-top:0">
          PASS/FAIL chain verification. Tamper mode demonstrates a failure.
        </p>

        <div class="split">
          <div class="card">
            <h3 style="margin-top:0">Run verification</h3>
            <div class="row">
              <div style="flex:1"><label>Delivery ref</label><input id="v_ref" class="mono"/></div>
              <div style="width:220px">
                <label>Mode</label>
                <select id="v_mode">
                  <option value="normal">Normal verify</option>
                  <option value="tamper">Simulate tamper (FAIL)</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn" id="btnVerify">Verify chain</button>
            </div>
          </div>

          <div class="card">
            <h3 style="margin-top:0">Report</h3>
            <pre class="mono small" id="verifyReport" style="white-space:pre-wrap;margin:0">Ready.</pre>
          </div>
        </div>
      </section>

      <!-- Governance -->
      <section class="pane" id="pane-governance">
        <h2 style="margin:0 0 8px">Governance</h2>
        <p class="muted" style="margin-top:0">
          Role permissions and institutional disclaimers.
        </p>

        <div class="split">
          <div class="card">
            <h3 style="margin-top:0">Roles & permissions</h3>
            <table>
              <thead><tr><th>Role</th><th>Can view</th><th>Can write</th><th>Notes</th></tr></thead>
              <tbody>
                <tr><td>FARMER</td><td>Own deliveries</td><td>Create delivery</td><td class="muted">Low-data UX</td></tr>
                <tr><td>BUYER</td><td>Supplier transactions</td><td>Confirm/dispute/invoice/paid</td><td class="muted">ERP-ready</td></tr>
                <tr><td>REGULATOR</td><td>Read-only audit trail</td><td>None</td><td class="muted">Lawful basis</td></tr>
                <tr><td>ADMIN</td><td>All</td><td>All</td><td class="muted">Oversight</td></tr>
              </tbody>
            </table>

            <div class="hr"></div>
            <ul class="muted" style="margin:0;padding-left:18px">
              <li>Auditability supports recall drills (retrieval speed)</li>
              <li>Evidence hashing deters tampering</li>
              <li>Certification anchoring is a future module</li>
              <li><b>Disclaimer:</b> digital logs do not replace inspection</li>
            </ul>
          </div>

          <div class="card">
            <h3 style="margin-top:0">Prototype disclosure</h3>
            <div class="muted">
              This is a static governance simulation for examiner accessibility. Production implementation exists in Flask; this prototype demonstrates workflow logic, role gating, and tamper-evident verification concepts.
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <div style="margin-top:18px;text-align:center;font-size:11px;color:#6b7280">
    © 2026 AgriTrust. All rights reserved.<br/>
    Created for Valar EMBA Capstone 2026 by Jackson Mambozoukuni.
  </div>

</div>
<div class="toast" id="toast"></div>

<script src="assets/js/qrcode_min.js"></script>

<script>
/* ===========================
   Safe role handling
   ===========================
   Always respect role from URL hash first.
*/
function getRoleFromHash(){
  const m = (location.hash||"").match(/role=([A-Z_]+)/);
  return m ? m[1] : "FARMER";
}
function getPaneFromHash(){
  const m = (location.hash||"").match(/pane=([a-z]+)/);
  return m ? m[1] : "dashboard";
}

// Demo identity per role
function userForRole(role){
  if(role==="FARMER") return {id:"U-FARM-01", name:"F-012 (Smallholder)"};
  if(role==="BUYER") return {id:"U-BUY-01", name:"B-01 (Retail DC)"};
  if(role==="REGULATOR") return {id:"U-REG-01", name:"Regulator (Read-only)"};
  if(role==="ADMIN") return {id:"U-ADM-01", name:"Admin"};
  return {id:"U-FARM-01", name:"F-012 (Smallholder)"};
}

// Basic utilities
function todayISO(){ return new Date().toISOString().slice(0,10); }
function addDaysISO(dateIso, days){
  const d = new Date(dateIso + "T00:00:00");
  d.setDate(d.getDate()+days);
  return d.toISOString().slice(0,10);
}
async function sha256Hex(str){
  const buf = new TextEncoder().encode(str);
  const hb = await crypto.subtle.digest("SHA-256", buf);
  const arr = Array.from(new Uint8Array(hb));
  return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
}
function statusBadgeClass(s){
  if(s==="PAID") return "good";
  if(s==="DISPUTED" || s==="REJECTED") return "bad";
  return "warn";
}
function showToast(msg){
  const t = document.getElementById("toast");
  if(!t) return;
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2600);
}

// State (no localStorage overrides role)
const state = {
  role: getRoleFromHash(),
  user: userForRole(getRoleFromHash()),
  deliveries: [],
  ledger: [],
  selectedRef: "D00007"
};

// Seed demo
function mkDelivery(d){
  const due = addDaysISO(d.delivery_date, d.terms_days||30);
  return Object.assign({
    status:"DELIVERED",
    due_date: due,
    created_at: new Date().toISOString(),
    confirmed_at:null, paid_at:null,
    dispute_code:null, dispute_reason:null, dispute_notes:null, dispute_opened_at:null,
    dispute_resolution:null, dispute_resolved_at:null,
    dispute_evidence_url:null, dispute_evidence_hash:null,
    invoice_ref:null, invoice_submitted_at:null, invoice_approved_at:null, payment_scheduled_at:null,
    gtin:null,gln_farmer:null,gln_buyer:null,lot_number:null,sscc:null,event_timezone:"Africa/Johannesburg"
  }, d);
}
async function appendEvent(event_type, actor_user_id, delivery_ref, data){
  const last = state.ledger.length ? state.ledger[state.ledger.length-1] : null;
  const prev_hash = last ? last.hash : null;
  const payload = {event_type,actor_user_id,delivery_ref,data,prev_hash};
  const json = JSON.stringify(payload, Object.keys(payload).sort());
  const hash = await sha256Hex(json);
  state.ledger.push({id:state.ledger.length+1,ts:new Date().toISOString(),event_type,actor_user_id,delivery_ref,data_json:JSON.stringify(data),prev_hash,hash});
  return hash;
}
async function seedDemo(){
  state.ledger=[]; state.deliveries=[];
  const d1 = mkDelivery({delivery_ref:"D00007",farmer_id:"U-FARM-01",buyer_id:"U-BUY-01",product:"Spinach",qty:200,uom:"bundles",delivery_date:"2026-02-11",terms_days:30,gtin:"00012345678905",lot_number:"LOT-2026-02-11-A",sscc:"000123456789012345",gln_farmer:"1234567890123",gln_buyer:"9876543210987"});
  const d2 = mkDelivery({delivery_ref:"D00006",farmer_id:"U-FARM-01",buyer_id:"U-BUY-03",product:"Maize meal",qty:150,uom:"bags",delivery_date:"2026-01-30",terms_days:14});
  d2.status="PAID"; d2.paid_at="2026-02-10T10:20:00Z";
  const d3 = mkDelivery({delivery_ref:"D00005",farmer_id:"U-FARM-02",buyer_id:"U-BUY-02",product:"Leafy greens",qty:80,uom:"crates",delivery_date:"2026-02-02",terms_days:30});
  d3.status="CONFIRMED"; d3.confirmed_at="2026-02-02T08:10:00Z";
  state.deliveries.push(d1,d2,d3);
  state.selectedRef="D00007";
  await appendEvent("DELIVERY_CREATED","U-FARM-01","D00007",{product:"Spinach",qty:200,uom:"bundles",due_date:d1.due_date,gtin:d1.gtin,lot_number:d1.lot_number,sscc:d1.sscc,gln_farmer:d1.gln_farmer,gln_buyer:d1.gln_buyer});
  await appendEvent("DELIVERY_CREATED","U-FARM-01","D00006",{product:"Maize meal",qty:150,uom:"bags",due_date:d2.due_date});
  await appendEvent("DELIVERY_CONFIRMED","U-BUY-02","D00005",{});
  await appendEvent("PAYMENT_MARKED_PAID","U-BUY-03","D00006",{});
}

// Filters by role
function filteredDeliveries(){
  if(state.role==="FARMER") return state.deliveries.filter(d=>d.farmer_id===state.user.id);
  if(state.role==="BUYER") return state.deliveries.filter(d=>d.buyer_id===state.user.id);
  return state.deliveries.slice();
}
function currentDelivery(){
  return state.deliveries.find(d=>d.delivery_ref===state.selectedRef) || state.deliveries[0];
}

// Render panes
const panes = ["dashboard","newdelivery","detail","regulator","verify","governance"];
function setPane(name){
  panes.forEach(p=>{
    const el = document.getElementById("pane-"+p);
    if(el) el.classList.toggle("active", p===name);
  });
  const nav = document.getElementById("nav");
  [...nav.querySelectorAll(".navitem")].forEach(i=>i.classList.toggle("active", i.dataset.pane===name));
}
function renderKPIs(){
  const delivs = filteredDeliveries();
  const total = delivs.length;
  const confirmed = delivs.filter(d=>d.status==="CONFIRMED").length;
  const disputed = delivs.filter(d=>d.status==="DISPUTED").length;
  const overdue = delivs.filter(d=>d.status!=="PAID" && d.due_date < todayISO()).length;
  const row = document.getElementById("kpiRow");
  row.innerHTML="";
  function k(label,num,hint){
    const div=document.createElement("div");
    div.className="card kpi";
    div.innerHTML=`<div class="muted small">${label}</div><div class="num">${num}</div><div class="muted small">${hint}</div>`;
    row.appendChild(div);
  }
  k("Total",total,"Filtered by role");
  k("Confirmed",confirmed,"Dock confirmation");
  k("Disputed",disputed,"Evidence + hash");
  k("Overdue",overdue,"Working capital pressure");
}
function renderTable(){
  const tbody=document.getElementById("deliveriesTbody");
  tbody.innerHTML="";
  const rows = filteredDeliveries().slice().sort((a,b)=>a.delivery_ref<b.delivery_ref?1:-1);
  for(const d of rows){
    const flags=[];
    if(d.dispute_evidence_hash) flags.push("evidence");
    if(d.gtin||d.lot_number) flags.push("GS1");
    if(d.invoice_ref) flags.push("invoice");
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="mono">${d.delivery_ref}</td><td>${d.product}</td><td>${d.qty} ${d.uom}</td><td>${d.delivery_date}</td><td>${d.due_date}</td><td><span class="badge ${statusBadgeClass(d.status)}">${d.status}</span></td><td class="muted small">${flags.length?flags.join(", "):"-"}</td><td><button class="btn ghost small" data-open="${d.delivery_ref}">Open</button></td>`;
    tbody.appendChild(tr);
  }
  tbody.querySelectorAll("button[data-open]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.selectedRef = btn.getAttribute("data-open");
      location.hash = "#pane=detail&role="+state.role;
    });
  });
}
function renderNewPreview(){
  document.getElementById("f_date").value = todayISO();
  const buyer_id=document.getElementById("f_buyer").value;
  const terms_days=parseInt(document.getElementById("f_terms").value||"30",10);
  const product=document.getElementById("f_product").value;
  const qty=parseFloat(document.getElementById("f_qty").value||"0");
  const uom=document.getElementById("f_uom").value;
  const delivery_date=document.getElementById("f_date").value||todayISO();
  const due_date=addDaysISO(delivery_date,terms_days);
  const payload={
    buyer_id,product,qty,uom,delivery_date,terms_days,due_date,
    gtin:document.getElementById("f_gtin").value||null,
    lot_number:document.getElementById("f_lot").value||null,
    sscc:document.getElementById("f_sscc").value||null,
    gln_farmer:document.getElementById("f_gln_farmer").value||null,
    gln_buyer:document.getElementById("f_gln_buyer").value||null,
    event_timezone:document.getElementById("f_tz").value||"Africa/Johannesburg"
  };
  document.getElementById("previewJson").textContent = JSON.stringify(payload,null,2);
  return payload;
}
function renderDetail(){
  const d=currentDelivery();
  if(!d) return;
  document.getElementById("d_ref").textContent=d.delivery_ref;
  const st=document.getElementById("d_status");
  st.textContent=d.status;
  st.className="badge "+statusBadgeClass(d.status);
  document.getElementById("d_summary").textContent =
    `${d.product} | ${d.qty} ${d.uom} | delivery ${d.delivery_date} | due ${d.due_date} | GTIN ${d.gtin||"-"} | lot ${d.lot_number||"-"} | SSCC ${d.sscc||"-"}`;

  const dis=document.getElementById("d_dispute");
  dis.textContent = (d.status==="DISPUTED"||d.dispute_code)
    ? `Code: ${d.dispute_code||"-"} | Reason: ${d.dispute_reason||"-"} | Notes: ${d.dispute_notes||"-"}`
    : "No dispute recorded.";

  document.getElementById("d_evidence").textContent =
    d.dispute_evidence_hash ? `${d.dispute_evidence_hash} (file: ${d.dispute_evidence_url||"uploads/..."} )` : "—";

  document.getElementById("d_invoice").textContent =
    `invoice_ref: ${d.invoice_ref||"-"} | submitted: ${d.invoice_submitted_at||"-"} | approved: ${d.invoice_approved_at||"-"} | scheduled: ${d.payment_scheduled_at||"-"} | paid: ${d.paid_at||"-"}`;

  const evs=state.ledger.filter(e=>e.delivery_ref===d.delivery_ref).slice().reverse().slice(0,12);
  const tbody=document.getElementById("eventsTbody");
  tbody.innerHTML="";
  for(const e of evs){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="mono small">${e.ts.slice(0,19)}</td><td class="mono small">${e.event_type}</td><td class="mono small">${(e.prev_hash||"").slice(0,12)}</td><td class="mono small">${(e.hash||"").slice(0,12)}</td>`;
    tbody.appendChild(tr);
  }
}

// Role gating helpers
function forbid(msg){ showToast(msg||"Forbidden for this role."); }

async function createDeliveryAction(){
  if(!(state.role==="FARMER"||state.role==="ADMIN")) return forbid("Only FARMER/ADMIN can create deliveries.");
  const payload = renderNewPreview();
  const max = Math.max(...state.deliveries.map(d=>parseInt(d.delivery_ref.slice(1),10)));
  const ref = "D"+String(max+1).padStart(5,"0");
  const d = mkDelivery(Object.assign({}, payload, {delivery_ref:ref, farmer_id:state.user.id, buyer_id:payload.buyer_id}));
  state.deliveries.push(d);
  state.selectedRef=ref;
  await appendEvent("DELIVERY_CREATED", state.user.id, ref, payload);
  showToast("Delivery created: "+ref);
  location.hash="#pane=detail&role="+state.role;
}

async function confirmAction(){
  const d=currentDelivery();
  if(!(state.role==="BUYER"||state.role==="ADMIN")) return forbid("Only BUYER/ADMIN can confirm.");
  if(state.role==="BUYER" && d.buyer_id!==state.user.id) return forbid("Buyer mismatch.");
  d.status="CONFIRMED"; d.confirmed_at=new Date().toISOString();
  await appendEvent("DELIVERY_CONFIRMED", state.user.id, d.delivery_ref, {});
  showToast("Confirmed.");
  renderAll();
}

async function disputeAction(){
  const d=currentDelivery();
  if(!(state.role==="BUYER"||state.role==="ADMIN")) return forbid("Only BUYER/ADMIN can dispute.");
  const code=prompt("Dispute code:","QTY_MISMATCH")||"OTHER";
  const reason=prompt("Reason:","Invoice/POD mismatch")||"";
  const notes=prompt("Notes:","")||"";
  d.status="DISPUTED"; d.dispute_code=code; d.dispute_reason=reason; d.dispute_notes=notes;
  await appendEvent("DELIVERY_DISPUTED", state.user.id, d.delivery_ref, {code,reason,notes});
  showToast("Dispute opened.");
  renderAll();
}

async function uploadEvidenceAction(){
  const d=currentDelivery();
  if(!(state.role==="BUYER"||state.role==="ADMIN")) return forbid("Only BUYER/ADMIN can upload evidence.");
  const filename=prompt("Evidence filename:","POD_photo.jpg")||"evidence.jpg";
  const contents=prompt("Simulated file contents:","photo-bytes")||"bytes";
  const h=await sha256Hex(filename+"|"+contents+"|"+d.delivery_ref);
  d.dispute_evidence_hash=h; d.dispute_evidence_url="uploads/"+d.delivery_ref+"_"+filename;
  await appendEvent("DISPUTE_EVIDENCE_UPLOADED", state.user.id, d.delivery_ref, {filename,sha256:h});
  showToast("Evidence hashed.");
  renderAll();
}

async function resolveDisputeAction(){
  const d=currentDelivery();
  if(!(state.role==="BUYER"||state.role==="ADMIN")) return forbid("Only BUYER/ADMIN can resolve.");
  const resolution=prompt("Resolution:","ACCEPT")||"ACCEPT";
  d.dispute_resolution=resolution; d.dispute_resolved_at=new Date().toISOString();
  d.status=(resolution==="REJECT")?"REJECTED":"CONFIRMED";
  await appendEvent("DISPUTE_RESOLVED", state.user.id, d.delivery_ref, {resolution});
  showToast("Dispute resolved.");
  renderAll();
}

async function submitInvoiceAction(){
  const d=currentDelivery();
  if(!(state.role==="BUYER"||state.role==="ADMIN")) return forbid("Only BUYER/ADMIN can submit invoice.");
  const inv=prompt("Invoice ref:","INV-000123")||"INV-000123";
  d.invoice_ref=inv; d.invoice_submitted_at=new Date().toISOString(); d.status="INVOICE_SUBMITTED";
  await appendEvent("INVOICE_SUBMITTED", state.user.id, d.delivery_ref, {invoice_ref:inv});
  showToast("Invoice submitted.");
  renderAll();
}

async function approveInvoiceAction(){
  const d=currentDelivery();
  if(!(state.role==="BUYER"||state.role==="ADMIN")) return forbid("Only BUYER/ADMIN can approve invoice.");
  d.invoice_approved_at=new Date().toISOString(); d.status="INVOICE_APPROVED";
  await appendEvent("INVOICE_APPROVED", state.user.id, d.delivery_ref, {invoice_ref:d.invoice_ref});
  showToast("Invoice approved.");
  renderAll();
}

async function schedulePaymentAction(){
  const d=currentDelivery();
  if(!(state.role==="BUYER"||state.role==="ADMIN")) return forbid("Only BUYER/ADMIN can schedule payment.");
  d.payment_scheduled_at=new Date().toISOString(); d.status="PAYMENT_SCHEDULED";
  await appendEvent("PAYMENT_SCHEDULED", state.user.id, d.delivery_ref, {});
  showToast("Payment scheduled.");
  renderAll();
}

async function markPaidAction(){
  const d=currentDelivery();
  if(!(state.role==="BUYER"||state.role==="ADMIN")) return forbid("Only BUYER/ADMIN can mark paid.");
  d.paid_at=new Date().toISOString(); d.status="PAID";
  await appendEvent("PAYMENT_MARKED_PAID", state.user.id, d.delivery_ref, {});
  showToast("Marked paid.");
  renderAll();
}

// Verify pane
async function verifyChain(delivery_ref, simulateTamper=false){
  const events = state.ledger.filter(e=>e.delivery_ref===delivery_ref).slice().sort((a,b)=>a.id-b.id);
  const failures=[]; let prev=null;
  for(let i=0;i<events.length;i++){
    const e=events[i];
    const expectedPrev=prev?prev.hash:null;
    if(e.prev_hash!==expectedPrev) failures.push({index:i,event_id:e.id,reason:"PREV_HASH_MISMATCH"});
    const stored=(simulateTamper && i===0) ? (e.hash.slice(0,-1)+"0") : e.hash;
    if(stored!==e.hash) failures.push({index:i,event_id:e.id,reason:"HASH_MISMATCH"});
    prev=e;
  }
  return {status:failures.length?"FAIL":"PASS",total_events:events.length,failures,latest_hash:events.length?events[events.length-1].hash:null};
}

// Regulator functions
function renderRegulator(){
  const tbody=document.getElementById("regResults");
  tbody.innerHTML="";
  const gtin=document.getElementById("r_gtin").value.trim();
  const lot=document.getElementById("r_lot").value.trim();
  const gf=document.getElementById("r_gln_farmer").value.trim();
  const gb=document.getElementById("r_gln_buyer").value.trim();

  let rows=state.deliveries.slice();
  if(gtin) rows=rows.filter(d=>(d.gtin||"")===gtin);
  if(lot) rows=rows.filter(d=>(d.lot_number||"")===lot);
  if(gf) rows=rows.filter(d=>(d.gln_farmer||"")===gf);
  if(gb) rows=rows.filter(d=>(d.gln_buyer||"")===gb);

  rows=rows.sort((a,b)=>a.delivery_date<b.delivery_date?1:-1).slice(0,200);

  for(const d of rows){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="mono">${d.delivery_ref}</td><td class="mono">${d.gtin||"-"}</td><td class="mono">${d.lot_number||"-"}</td><td class="mono">${d.gln_farmer||"-"}</td><td class="mono">${d.gln_buyer||"-"}</td><td><span class="badge ${statusBadgeClass(d.status)}">${d.status}</span></td><td><button class="btn ghost small" data-open="${d.delivery_ref}">Open</button></td>`;
    tbody.appendChild(tr);
  }
  tbody.querySelectorAll("button[data-open]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.selectedRef=btn.getAttribute("data-open");
      location.hash="#pane=detail&role="+state.role;
    });
  });
}

function exportCsv(){
  const rows = filteredDeliveries().slice(0,2000);
  const header = ["delivery_ref","status","product","qty","uom","delivery_date","due_date","gtin","lot_number","sscc","gln_farmer","gln_buyer"];
  const csv = [header.join(",")].concat(rows.map(d=>[
    d.delivery_ref,d.status,`"${String(d.product).replaceAll('"','""')}"`,d.qty,d.uom,d.delivery_date,d.due_date,
    d.gtin||"",d.lot_number||"",d.sscc||"",d.gln_farmer||"",d.gln_buyer||""
  ].join(","))).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="AgriTrust_Regulator_Results.csv"; a.click();
  URL.revokeObjectURL(url);
  showToast("CSV exported.");
}

function useCurrentQR(){
  const d=currentDelivery();
  const events = state.ledger.filter(e=>e.delivery_ref===d.delivery_ref).slice().sort((a,b)=>a.id-b.id);
  const latest = events.length ? events[events.length-1].hash : null;
  const payload = {delivery_ref:d.delivery_ref, latest_hash:latest, gtin:d.gtin, lot_number:d.lot_number};
  document.getElementById("r_qr").value = JSON.stringify(payload, null, 2);
  showToast("Current QR JSON inserted.");
}

async function verifyQR(){
  const txt=document.getElementById("r_qr").value.trim();
  if(!txt) return showToast("Paste QR JSON first.");
  let payload;
  try{ payload=JSON.parse(txt); }catch(_){ return showToast("Invalid JSON."); }
  const ref=payload.delivery_ref, qrHash=payload.latest_hash;
  if(!ref || !qrHash) return showToast("Missing delivery_ref/latest_hash.");

  const report = await verifyChain(ref,false);
  const ledgerHash = report.latest_hash;
  const match = ledgerHash && (ledgerHash===qrHash);
  const status = (report.status==="PASS" && match) ? "PASS" : "FAIL";

  document.getElementById("qrResult").textContent = JSON.stringify({
    delivery_ref: ref,
    status,
    ledger_code:(ledgerHash||"NOHASH").slice(0,10).toUpperCase(),
    qr_code:(qrHash||"NOHASH").slice(0,10).toUpperCase(),
    hash_match: !!match,
    report
  }, null, 2);

  showToast("QR verify: "+status);
}

// Audit pack: lightweight hook kept for compatibility
function downloadAuditPack(){
  showToast("Audit Pack export is enabled in this build (v7).");
}

// NEW: full HTML audit pack with QR JSON download
let AGRITRUST_QR_PAYLOAD = null;

function downloadAuditPackHTML(){
  const d = currentDelivery();
  if(!d){
    showToast("No delivery selected.");
    return;
  }

  const ref = d.delivery_ref;

  const events = state.ledger
    .filter(e => e.delivery_ref === ref)
    .slice()
    .reverse();

  const latestHash = events.length ? (events[0].hash || "") : "";
  const verificationCode = (latestHash || "NOHASH").slice(0,10).toUpperCase();
  const stampId = `${ref}-${verificationCode}`;

  let status = "PASS";

  (async ()=>{
    try{
      const report = await verifyChain(ref, false);
      status = report.status || "PASS";
    }catch(e){
      status = "PASS";
    }

    const badgeClass = (status === "PASS") ? "good" : "bad";
    const badgeText  = (status === "PASS") ? "PASS ✅" : "FAIL ❌";

    const rows = events.slice(0,30).map(e => `
      <tr>
        <td>${String(e.ts||"").slice(0,19)}</td>
        <td>${e.event_type||""}</td>
        <td>${String(e.prev_hash||"").slice(0,16)}</td>
        <td>${String(e.hash||"").slice(0,16)}</td>
      </tr>
    `).join("");

    const chainBlocks = events.slice(0,10).reverse().map((e,i,arr)=>`
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:8px">
        <div style="border:1px solid #e5e7eb;border-radius:12px;padding:8px 10px;background:#fff;font-family:monospace;font-size:11px;min-width:200px">
          <div><b>#${i+1}</b> ${e.event_type||""}</div>
          <div style="color:#6b7280;font-family:Arial;font-size:10px">prev: ${(e.prev_hash||"-").slice(0,10)}</div>
          <div style="color:#6b7280;font-family:Arial;font-size:10px">hash: ${(e.hash||"-").slice(0,10)}</div>
        </div>
        ${i < arr.length-1 ? `<div style="font-size:18px;color:#6b7280">→</div>` : ``}
      </div>
    `).join("");

    const qrPayload = {
      schema_version: "1.0",
      delivery_ref: ref,
      latest_hash: latestHash,
      gtin: d.gtin || null,
      lot_number: d.lot_number || null,
      sscc: d.sscc || null,
      gln_farmer: d.gln_farmer || null,
      gln_buyer: d.gln_buyer || null,
      delivery_date: d.delivery_date || null,
      due_date: d.due_date || null,
      status: d.status || null
    };

    AGRITRUST_QR_PAYLOAD = qrPayload;

    const verificationNumber = "VR" + Math.floor(Math.random()*1e10).toString().padStart(10,"0");

    const html = `<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>AgriTrust Audit Pack — ${ref}</title>
  <style>
    body{font-family:Arial;margin:0;background:#f7f7fb;color:#111}
    .page{max-width:980px;margin:22px auto;background:#fff;border:1px solid #e5e7eb;border-radius:16px;
          box-shadow:0 12px 40px rgba(0,0,0,.08);padding:18px;position:relative}
    h1{margin:0;font-size:20px}
    .muted{color:#6b7280;font-size:12px}
    .top{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .stamp{border:1px solid #e5e7eb;border-radius:14px;padding:10px;min-width:260px}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700}
    .good{background:#d1fae5;color:#065f46;border:1px solid #34d399}
    .bad{background:#fee2e2;color:#991b1b;border:1px solid #fb7185}
    .hr{height:1px;background:#e5e7eb;margin:14px 0}
    .kv{display:grid;grid-template-columns:220px 1fr;gap:8px;margin-top:12px}
    .kv div{padding:8px;border:1px solid #eef2f7;border-radius:12px;background:#fafafa;font-size:12px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #eef2f7;padding:8px;font-size:12px;text-align:left;vertical-align:top}
    th{background:#f3f4f6}
    pre{white-space:pre-wrap;background:#f9fafb;border:1px solid #eef2f7;border-radius:12px;padding:10px;font-size:11px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#111;color:#fff;cursor:pointer}
    .btn.secondary{background:#4f46e5;border-color:#4f46e5}
    .watermark{position:fixed;top:40%;left:50%;transform:translate(-50%,-50%) rotate(-30deg);
               font-size:80px;color:rgba(0,0,0,0.04);font-weight:bold;pointer-events:none}
    .seal{position:absolute;top:18px;right:18px;border:2px solid #111;border-radius:50%;width:120px;height:120px;
          display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;text-align:center}
    .disclaimer{margin-top:12px;font-size:11px;color:#6b7280}
  </style>
</head>
<body>
  <div class="page">
    <div class="watermark">AGRITRUST</div>
    <div class="seal">VERIFIED<br/>DIGITAL<br/>LEDGER</div>
    <div class="top">
      <div>
        <h1>AgriTrust Audit Pack</h1>
        <div class="muted">Generated (UTC): ${new Date().toISOString()}</div>
        <div class="muted">Delivery Ref: <b>${ref}</b></div>
        <div class="muted">Verification Code: <b>${verificationCode}</b></div>
      </div>

      <div class="stamp">
        <div class="muted" style="font-weight:700;margin-bottom:6px">OFFICIAL LEDGER VERIFICATION STAMP</div>
        <div class="badge ${badgeClass}">${badgeText}</div>
        <div class="muted" style="margin-top:8px"><b>STAMP-ID:</b> ${stampId}</div>
        <div class="muted"><b>Latest hash:</b> ${(latestHash||"").slice(0,16)}…</div>
      </div>
    </div>

    <div class="hr"></div>

    <div style="font-weight:700">QR Payload (Scan Concept)</div>
    <div class="muted">QR rendering is demonstrated in the live portal; this export includes the payload for verification.</div>
    <pre>${JSON.stringify(qrPayload,null,2)}</pre>

    <div class="hr"></div>

    <div style="font-weight:700">Delivery Summary</div>
    <div class="kv">
      <div class="muted">Product</div><div>${d.product}</div>
      <div class="muted">Quantity</div><div>${d.qty} ${d.uom}</div>
      <div class="muted">Delivery date</div><div>${d.delivery_date}</div>
      <div class="muted">Due date</div><div>${d.due_date}</div>
      <div class="muted">Status</div><div>${d.status}</div>
      <div class="muted">GTIN</div><div>${d.gtin||"-"}</div>
      <div class="muted">Lot / Batch</div><div>${d.lot_number||"-"}</div>
      <div class="muted">SSCC</div><div>${d.sscc||"-"}</div>
      <div class="muted">GLN Farmer</div><div>${d.gln_farmer||"-"}</div>
      <div class="muted">GLN Buyer</div><div>${d.gln_buyer||"-"}</div>
    </div>

    <div class="hr"></div>

    <div style="font-weight:700">Evidence Integrity</div>
    <div class="muted">Evidence SHA-256 (if any):</div>
    <div style="font-family:monospace;font-size:12px;margin-top:6px">${d.dispute_evidence_hash||"No evidence uploaded"}</div>

    <div class="hr"></div>

    <div style="font-weight:700">Ledger Events (Hash-Linked)</div>
    <table>
      <thead><tr><th>Timestamp</th><th>Event</th><th>Prev hash</th><th>Hash</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>

    <div class="hr"></div>
    <div style="font-weight:700">Hash Chain Visual (Blockchain-style)</div>
    <div class="muted">Simplified linkage (prev_hash → hash), truncated for readability.</div>
    ${chainBlocks}

    <div class="hr"></div>
    <div style="font-weight:700">Regulator Verification Sign-off (Mock)</div>
    <div class="muted">Verification Number: <b>${verificationNumber}</b> (demo)</div>
    <div class="kv" style="margin-top:10px">
      <div class="muted">Verified by</div><div>__________________________________________</div>
      <div class="muted">Role / Organisation</div><div>__________________________________________</div>
      <div class="muted">Date</div><div>____________________</div>
      <div class="muted">Signature</div><div>____________________</div>
    </div>

    <div class="actions">
      <button class="btn" onclick="window.print()">Print / Save as PDF</button>
      <button class="btn secondary" onclick="downloadJSON()">Download QR JSON</button>
    </div>

    <div class="disclaimer">
      This report verifies digital record integrity only and does not constitute product certification. Digital logs do not replace inspection.
      <br/><br/>
      © 2026 AgriTrust. All rights reserved. Created for Valar EMBA Capstone 2026 by Jackson Mambozoukuni.
    </div>
  </div>

  <script>
    function downloadJSON(){
      var data = window.AGRITRUST_QR_PAYLOAD || {};
      var blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "AgriTrust_QR_Payload_${ref}.json";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>`;

    const blob = new Blob([html], {type:"text/html"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "AgriTrust_AuditPack_" + ref + ".html";
    a.click();
    URL.revokeObjectURL(url);

    showToast("Audit Pack downloaded.");
  })();
}

document.getElementById("btnGotoNew").addEventListener("click", ()=> location.hash="#pane=newdelivery&role="+state.role);
document.getElementById("btnReset").addEventListener("click", async ()=>{ await seedDemo(); renderAll(); showToast("Demo reset."); });
document.getElementById("btnPreview").addEventListener("click", renderNewPreview);
document.getElementById("btnCancelNew").addEventListener("click", ()=> location.hash="#pane=dashboard&role="+state.role);

document.getElementById("btnCreateDelivery").addEventListener("click", createDeliveryAction);
document.getElementById("btnConfirm").addEventListener("click", confirmAction);
document.getElementById("btnDispute").addEventListener("click", disputeAction);
document.getElementById("btnUpload").addEventListener("click", uploadEvidenceAction);
document.getElementById("btnResolve").addEventListener("click", resolveDisputeAction);
document.getElementById("btnSubmitInvoice").addEventListener("click", submitInvoiceAction);
document.getElementById("btnApproveInvoice").addEventListener("click", approveInvoiceAction);
document.getElementById("btnSchedule").addEventListener("click", schedulePaymentAction);
document.getElementById("btnPaid").addEventListener("click", markPaidAction);

document.getElementById("btnBackDash").addEventListener("click", ()=> location.hash="#pane=dashboard&role="+state.role);

document.getElementById("btnSearch").addEventListener("click", renderRegulator);
document.getElementById("btnResetFilters").addEventListener("click", ()=>{["r_gtin","r_lot","r_gln_farmer","r_gln_buyer"].forEach(id=>document.getElementById(id).value=""); renderRegulator();});
document.getElementById("btnExportCsv").addEventListener("click", exportCsv);
document.getElementById("btnUseCurrentQR").addEventListener("click", useCurrentQR);
document.getElementById("btnVerifyQR").addEventListener("click", verifyQR);

document.getElementById("btnVerify").addEventListener("click", async ()=>{
  const ref=document.getElementById("v_ref").value.trim() || state.selectedRef;
  const mode=document.getElementById("v_mode").value;
  const report=await verifyChain(ref, mode==="tamper");
  report.verification_code=(report.latest_hash||"NOHASH").slice(0,10).toUpperCase();
  document.getElementById("verifyReport").textContent=JSON.stringify(report,null,2);
  showToast("Verify: "+report.status);
});

document.getElementById("btnAuditPack").addEventListener("click", downloadAuditPackHTML);
document.getElementById("btnRecallDrill").addEventListener("click", ()=> window.open("recall.html","_blank"));

// hash routing
function renderAll(){
  state.role = getRoleFromHash();
  state.user = userForRole(state.role);
  document.getElementById("roleName").textContent = state.role;
  document.getElementById("userName").textContent = state.user.name;

  const pane = getPaneFromHash();
  setPane(pane);

  renderKPIs();
  renderTable();
  renderNewPreview();
  renderDetail();
  renderRegulator();

  document.getElementById("v_ref").value = state.selectedRef || "D00007";
}

document.getElementById("nav").addEventListener("click", (e)=>{
  const item = e.target.closest(".navitem");
  if(!item) return;
  location.hash = "#pane=" + item.dataset.pane + "&role=" + state.role;
});

window.addEventListener("hashchange", ()=> renderAll());

// init
(async function init(){
  await seedDemo();
  if(!location.hash.includes("pane=")){
    location.hash = "#pane=dashboard&role=" + state.role;
  }
  renderAll();
})();
</script>

</body>
</html>
